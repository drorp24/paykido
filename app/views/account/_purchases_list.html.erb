<div class="box-header">
    <span class="icon16 cart"></span>
    <h1><%= t 'Purchases' %></h1> 
</div>

<div class="action_bar filters">
    <a href="#" class="small button" id="pending-button">
        <span class="icon16 question"></span>
        Pending
        <span class="message-count"><%= @pendings_count %></span>
    </a>
    <a href="#" class="small button" id="authorized-button">
        <span class="icon16 tick2"></span>
        Approved
    </a>
    <a href="#" class="small button" id="blocked-button">
        <span class="icon16 blocked"></span>
        Blocked
    </a>
    <a href="#" class="small button" id="all-button">
        <span class="icon16 refresh"></span>
        All
    </a>
</div> 
  
<table id="purchases"> 
    <thead> 
        <tr> 
            <th>Date invisible</th>
            <th>Auth type invisible</th>
            <th>Authorized invisible</th>
            <th>
            <th>
            <th>
            <th>                             
        </tr> 
    </thead> 
    <tbody> 
    <% @purchases.each do |purchase| %>                                
        <tr> 
            <td><%= purchase.date %></td>
            <td><%= purchase.authorization_type %></td>
            <td><%= purchase.authorized %></td>
            <td class="status">
            <% if purchase.requires_approval? %>
                <span class="icon16 question tooltip" title="Requires your approval"></span>
            <% elsif purchase.approved? %> 
                <span class="icon16 tick2 tooltip" title="You approved it"></span>
            <% elsif purchase.declined? %> 
                <span class="icon16 cross tooltip" title="You declined it"></span>
            <% elsif purchase.authorized? %> 
                <span class="icon16 openlock tooltip" title="Approved based upon your rules"></span>
            <% elsif purchase.unauthorized? %> 
                <span class="icon16 lock tooltip" title="<%= t purchase.authorization_type %>"></span>
            <% else %> 
                <span class="icon16 alert tooltip" title="Well this was not supposed to happen"></span>
            <% end %>
            </td>
            <td>
                <p class="purchase_top_line">
                    <span><%= link_to purchase.product ,"dashboard/product/#{purchase.id}" %></span>
                    <span>by</span>
                    <span><%= link_to purchase.retailer.name, "dashboard/retailer/#{purchase.id}" %></span>
                </p>
                <p class="purchase_bottom_line">
                    <span class="cell_date"><%= purchase.date.strftime("%a, %b %d") %></span>
                    <span><%= link_to purchase.consumer.name, "dashboard/consumer/#{purchase.consumer_id}"  %></span>
                </p>
            </td>
            <td class="ar"><%= number_to_currency(purchase.amount) %></td>
            <td class="approval_buttons">
                <% if purchase.requires_manual_approval? %>
                <p class="purchase_top_line">
                    <a href='' class=" button small greyedOut actionButton approve" id=<%= "approve_#{purchase.id}"%>>
                        <span class="icon16 tick2"></span>
                        OK
                    </a>
                </p>
                <p class="purchase_bottom_line">
                     <a href="#" class="button small greyedOut actionButton decline"  id=<%= "decline_#{purchase.id}"%>>
                        <span class="icon16 cross"></span>
                        NO
                    </a>
                </p>
                <% end %>
            </td>                    
        </tr>                                   
    <% end %>
    </tbody> 
</table> 

<%= render 'approval_popover' %>

<script type="text/javascript"> 

$(document).ready(function() {

	// trigger the approval popover
    $('.message-count').popover('#approval_popover', {preventLeft: true, preventBottom: true});
	// these 2 lines should be removed once popover acts as it should 
    $('.message-count').trigger('open.popover');      
	window.setTimeout("$('#pending_reminder').fadeOut('slow')", 5000);
               
	// these lines should be removed either - .pjax functionality is 'lost'. Probably related to the above problem.
    $('.purchase_top_line a').pjax({				 
        container: '#dashboard_right',
        success: function(data) {
            $('input[type=checkbox], input[type=radio]').each(function() {
              if($(this).siblings('label').length > 0) {
                $(this).prettyCheckboxes();
              }
            });

        }
    });


// DataTables (http://datatables.net/)
   pTable = $('#purchases').dataTable( {
        "sPaginationType": "full_numbers",
        "aoColumnDefs": [
        { "bVisible": false, "aTargets": [ 0,1,2 ] }
        ],
        "aaSorting": [[0,'desc']]
    } );
        
    $('.action_bar.filters a').removeClass('blue');
    $('#pending-button').addClass('blue');
    pTable.fnFilter( 'PendingPayer' , 1, true, false, false);            
        

//	The following is in charge of the 4 filter buttons
//	Filtering is currently silly (based on 'authorization_type' column) - should be replaced by 'authorized' column.

    $('#pending-button').click(function () {
            $('.action_bar.filters a').removeClass('blue');
            $(this).addClass('blue');
             pTable.fnFilter( 'PendingPayer' , 1, true, false, false);
    });

    $('#authorized-button').click(function () {
            $('.action_bar.filters a').removeClass('blue');
            $(this).addClass('blue');
            pTable.fnFilter('Whitelisted|Approved|Authorized|Always|Under', 1, true, false, false );
    });

    $('#blocked-button').click(function () {
            $('.action_bar.filters a').removeClass('blue');
            $(this).addClass('blue');
            pTable.fnFilter('Blacklisted|Low|High|Unauthorized|Declined|Zero|Insufficient|Over', 1, true, false, false);
    });

     $('#all-button').click(function () {
            $('.action_bar.filters a').removeClass('blue');
            $(this).addClass('blue');
            pTable.fnFilter( '', 1, true, false, false );
    });
});

</script>